<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Bootstrap 5 CSS (CDN) -->
    <link href="http://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
    <title>Bootstrap Example</title>
    <script src="http://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <!-- and it's easy to individually load additional languages -->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/javascript.min.js"
        integrity="sha512-yfJUrNGEC39mHLjZ37CZG69Ij9Vnan7NHxXVuuBxafgfk4F+n7j/NhNWtyhKGTYEgWfgUqzPYMZJZY1HIsPCbQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/python.min.js"
        integrity="sha512-/uCTceIDOniHf+VUKbCnP/x6GQSRrm4GwUtQYMgKa9yIZPGzlR04flSsD+2or7bPn44VY9inIHI4cwNCcZmJDw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet"
        href="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/atom-one-dark.min.css"
        integrity="sha512-Jk4AqjWsdSzSWCSuQTfYRIF84Rq/eV0G2+tu07byYwHcbTGfdmLrHjUSwvzp5HvbiqK4ibmNwdcG49Y5RGYPTg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <title>Local LLM</title>

</head>

<body class="bg-white text-dark min-vh-100 d-flex align-items-center justify-content-center">
    <div class="col-sm-10 col-md-8 col-lg-8 col-xl-8 p-4 rounded bg-light">
        <h1 class="display-4 font-weight-bold mb-5">
            Local LLM Chat
        </h1>

        <!-- Model Dropdown in the Top Right Corner -->
        <div class="dropdown position-absolute top-0 end-0 mt-4 me-4">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="modelDropdown"
                data-bs-toggle="dropdown" aria-expanded="false">
                Select Model
            </button>
            <ul class="dropdown-menu" aria-labelledby="modelDropdown" role="menu">
                <li role="presentation"><a role="menuitem" class="dropdown-item" href="#" data-model="1">These will be replaced with the list below</a></li>
                <li role="presentation"><a role="menuitem" class="dropdown-item" href="#" data-model="2">These will be replaced with the list below</a></li>
            </ul>
        </div>
        <label>System Prompt</label>
        <input type="text" id="sysPromptInput" class="form-control form-control-lg mt-4"/>

        <div id="resultContainer" class="mt-3 h-48 overflow-auto">
            <p class="text-muted small mb-2"></p>
            <div id="resultText"></div>
        </div>
        <input type="text" id="userPromptInput" class="form-control form-control-lg mt-4" placeholder="How can I help you..." />
        <div class="d-flex justify-content-center mt-4">
            <button id="generateBtn"
                class="btn btn-dark btn-lg w-50 mr-2 disabled-opacity-75 disabled:cursor-not-allowed">
                Generate
            </button>
            <button id="stopBtn" disabled
                class="btn btn-outline-secondary btn-lg w-50 ml-2 disabled-opacity-75 disabled:cursor-not-allowed">
                Stop
            </button>
            <button id="clearBtn" class="btn btn-outline-danger btn-lg w-50 ml-2">
                Clear
            </button>
        </div>
    </div>

    <script>

        const API_URL = "http://localhost:5000/api/message";//"https://api.openai.com/v1/chat/completions"; //use this if you choose to use an OpenAI model

        const userPromptInput = document.getElementById("userPromptInput");
        const generateBtn = document.getElementById("generateBtn");
        const stopBtn = document.getElementById("stopBtn");
        const resultText = document.getElementById("resultText");
        const clearBtn = document.getElementById("clearBtn");
        const modelDropdownBtn = document.getElementById("modelDropdown"); // Dropdown button element
        const sysPrompt = document.getElementById("sysPromptInput");

        let selectedModel = 7; // See server.js

        // Mapping model numbers to model names for easy lookup
        const modelNames = {
            1: "phi4:14b-q4_K_M",
            2: "qwen2.5-coder:7b",
            3: "granite3.1-moe:3b-instruct-q8_0",
            4: "deepseek-r1:1.5b",
            5: "llama3.2:latest",
            6: "deepseek-r1:latest",
            7: "llama3.2:3b",
            8: "deepseek-coder-v2:latest"
            //add others but the server.js must recognize these and switch to corresponding OLLAMA model name
        };

        function onContentLoaded() {

            sysPrompt.value = "You will only answer questions that pertain to Python programming language. And politely decline to say anything other than that.";

            updateModel(selectedModel); // Set the dropdown button text when the page loads

            const dropdownMenu = document.querySelector(".dropdown-menu");

            // Clear existing dropdown items (if any)
            dropdownMenu.innerHTML = "";

            // Populate dropdown with models
            Object.keys(modelNames).forEach(key => {
                const listItem = document.createElement("li");
                listItem.role = "presentation";

                const anchor = document.createElement("a");
                anchor.href = "#";
                anchor.className = "dropdown-item";
                anchor.setAttribute("role", "menuitem");
                anchor.setAttribute("data-model", key);
                anchor.textContent = modelNames[key];

                listItem.appendChild(anchor);
                dropdownMenu.appendChild(listItem);
            });

            // Add event listeners for selection
            document.querySelectorAll(".dropdown-item").forEach(item => {
                item.addEventListener("click", (e) => {
                    e.preventDefault();
                    selectedModel = e.target.getAttribute("data-model");
                    document.getElementById("modelDropdown").textContent = modelNames[selectedModel];
                });
            });
        }

        // Function to update selected model (sending numbers)
        const updateModel = (modelNumber) => {
            selectedModel = modelNumber;
            modelDropdownBtn.textContent = modelNames[selectedModel]; // Update the dropdown button text
        };

        let controller = null; // Store the AbortController instance

        const scrollToBottom = () => {
            window.scrollTo(0, document.body.scrollHeight);
        };

        const generate = async () => {
            // Alert the user if no prompt value
            if (!userPromptInput.value) {
                alert("Please enter a prompt.");
                return;
            }

            // Disable the generate button and enable the stop button
            generateBtn.disabled = true;
            stopBtn.disabled = false;
            resultText.innerText = "Generating...";

            // Create a new AbortController instance
            controller = new AbortController();
            const signal = controller.signal;

            try {
                // Fetch the response from the OpenAI API with the signal from AbortController
                const imessages = [
                    { role: 'system', content: sysPrompt.value },
                    { role: "user", content: userPromptInput.value },
                ];
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: selectedModel,
                        messages: imessages,
                        max_tokens: 100,
                        stream: true, // For streaming responses
                    }),
                    signal, // Pass the signal to the fetch request
                });

                // Read the response as a stream of data
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                resultText.innerText = "";
                let fullmessage = null;
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        break;
                    }
                    // Massage and parse the chunk of data
                    const chunk = decoder.decode(value);
                    resultText.innerText += chunk;
                    fullmessage += chunk;
                    scrollToBottom();
                }
            } catch (error) {
                // Handle fetch request errors
                if (signal.aborted) {
                    resultText.innerText += "...Request aborted.";
                } else {
                    console.error("Error:", error);
                    resultText.innerText = "Error occurred while generating. See server logs.";
                }
            } finally {
                // Enable the generate button and disable the stop button
                generateBtn.disabled = false;
                stopBtn.disabled = true;
                controller = null; // Reset the AbortController instance
            }
        };

        const clear = () => {
            resultText.innerText = ""; // Clear the result text
            userPromptInput.value = ""; // Clear the prompt input field
        };

        const stop = () => {
            // Abort the fetch request by calling abort() on the AbortController instance
            if (controller) {
                controller.abort();
                controller = null;
            }
        };

        userPromptInput.addEventListener("keyup", (event) => {
            if (event.key === "Enter") {
                generate();
            }
        });

        generateBtn.addEventListener("click", generate);
        stopBtn.addEventListener("click", stop);
        clearBtn.addEventListener("click", clear);

        document.addEventListener("DOMContentLoaded", onContentLoaded);

    </script>
    <script>
        // if (hljs) { hljs.highlightAll(); }
    </script>
</body>

</html>